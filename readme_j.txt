※ご注意：　日英両方のreadmeを書くのはシンドイので、この日本語版readmeについては、SEIB-v2.61以降の更新をやめました。
このファイルは。一応、まだ参考になる部分もあるかと思い添付しているだけですので、コードの使用に際してはreade.txtを参照されて下さい。

□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□
SEIB-DGVM 取り扱い説明書 (日本語版、2010年11月30日改訂)

佐藤永（名古屋大学環境学研究科）
http://seib-dgvm.com/hsato/

　　　--- 目次 ---
・使用許諾条件
・ファイル構成
・実行手順（裸地からの実行）
・実行手順（リスタート実行）
・設定ファイル
・SEIB-Viewer
・main.f90中のコードの流れ
・解析プログラム
・エディタについて
・改行コードについて
・その他の注意
□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□


■■■■　使用許諾条件 (ver 1.0)　■■■■
(1) SEIB-DGVMのコードは、研究用途に限り個人・法人問わず御利用いただけます。営利や行政計画への利用を希望される場合には、予め佐藤永の許可を得てください。
(2) コードの正確さや出力の精度に関しての保証はいたしかねますので、利用によって、いかなる問題が発生しても、当方ではいっさい責任を持ちません。
(3) コードの再配布は自由ですが、その際、ファイル構成や内容は変更しないで下さい。また、改変したコードの再配布を希望される場合には、予め佐藤永の許可を得てください。
(4) このコードを利用した研究成果を出版される際には、適切な文献を引用してください。なお、このコードを使用した出版物につきましては、一部お送り願えれば幸いに存じます。


■■■■　ファイル構成　■■■■
●説明文章　＠トップフォルダ
readme.txt  
history.txt  更新履歴

readme_j.txt   日本語によるコード利用法（この文章）
readme_e.txt   英語によるコード利用法
history.txt    更新履歴
Model_description_??????_.pdf   最新版モデルの記述

●ソースコード　＠フォルダ"Code"
start_point.f90     パラメーターと気象土壌データの読み出し
modules.f90         全ルーチンで共有する定数・関数の宣言
main.f90            メインルーチン
initialize.f90      初期化
physics.f90         物理過程（放射収支、水収支など）
metabolic.f90       生理過程（光合成、呼吸、成長など）
spacial_calc.f90    三次元空間計算（個体毎の光環境など）
population_regu.f90 植生動態過程（死亡、定着、攪乱など）
output.f90          出力ファイルの作成
etc.f90             上のカテゴリーに入らない諸サブプログラム

●パラメーター定義ファイル　＠フォルダ"Code"
parameter.txt

●サンプル気象データ　＠フォルダ"Code"
climate.txt     モデル入力用のサンプル気象データ。カンマ区切りのテキスト形式。SEIB-DGVMウェブサイト上の気象データジェネレーターで、北緯2度58分、東経102度18分、期間1901〜2005年を指定して作成。なお、この位置はマレーシアのパソ実験林に相当する。

●土地情報データ　＠フォルダ"Code"
land_prop.txt     モデル入力用の全球１度グリッドメッシュの土地情報データ。カンマ区切りのテキスト形式。北緯90度西経180度を起点に東方向にデータが並べられ、東経180度に達したら次は北緯89度180度よりデータが始まる。Global Soil Wetness Project 2（http://grads.iges.org/gswp/）の入力用データをダウンロードして、整形したもの。引用方法やデータの利用規程については、特にWEBページに記述が見あたらなかった。各行のデータの並び順は次の通り：Land Mask (海:0, 陸:1)、平均高度 (m)、土壌アルベド、最大保水量(saturation point)、圃場容水量(field capacity)、基質吸引力(matrix potential)、萎れ点(wilting point)。

●基本解析プログラム　＠フォルダ"Tools"
analysis1.f90        森林動態の基本値を出力するプログラム
Viewer_snapshot.pov  仮想林分表示用のPOV-RAYプログラム(静止画)
Viewer_animation.pov  仮想林分表示用のPOV-RAYプログラム(連続画)

●SEIB-Viewer　＠フォルダ"SEIB-Viewer"
このフォルダには、プログラム本体と、その実行に必要なファイルを含む２つのサブフォルダが納められています。


■■■■　実行手順（裸地からスタートする場合）　■■■■
(1) 座標を指定する。 star_point.f90中の
  LAT     =  2.97 !north:+, south:- (decimalized)
  LON     = 102.3 ! east:+,  west:- (decimalized)

という箇所を、シミュレートさせる場所の緯度経度に書き換える。緯度は+90〜-90までの数値が入力可能で北緯が+南緯は-で指定、経度は+180〜-180が入力可能で東経が+西経は-で指定。なお、小数点以下は"分"ではなくて十進法にて記入すること。

(2) 必要であればmodules.f90中のパラメーターを変える。ここには、例えば以下のようなパラメーターが含まれている。
Max_no            シミュレートする木本個体の最大数
Max_hgt           シミュレートする仮想林分の高さレイヤー数。光分布計算を行わせる際に参照する。１レイヤーの厚みは、以下で説明するパラメーターSTEPにより定義される。少し余裕を持って（最大樹高＋α）設定すること。
Dived             木本定着メッシュの細かさ。例えば10と指定すると、仮想林分の林床を10×10=100に区分し、各区分の中心に木本が定着できる事になる。せめてMax_locと同じ程度の値にしないと、森林のシミュレーションとしては不自然。
DivedG             林床に存在する草本セルの解像度。例えば10と指定すると、仮想林分の林床に10×10=100個の草本セルが存在することになる。各草本セルは独立に、それぞれの場所の光条件における成長のシミュレーションをに行う。但し、光以外の環境条件（土壌含水率など）は同じ仮想林分の全ての草本セルで共通である。

(3) 実行ファイルを作成する。start_point.f90中にinclude文で他のプログラムファイル名が指定されているので、start_point.f90のみをコンパイルするようコマンドを打てば、全コードが自動的に変換される。具体的には、実行ファイル名をgo.outとするのなら、コマンドラインより以下のように入力する。
　　　f90 start_point.f90 -o go.out
この例は、コンパイルコマンドが「f90」の場合。Intel Fortranでは「ifort」、g95コンパイラでは「g95」とすること。

(4) パラメーターファイルparameter.txtの設定。重要な点は次の２つ：(1)気象データと土地データの置かれているディレクトリをFullPathで指定。(2)Simulation_yearに、シミュレーションさせる年数を指定する。実行環境の計算速度がよく分からないうちは、20年程度を指定して様子を見ること。なお、parameter.txtは実行ファイルと同一ディレクトリに置くこと。

(5) 実行ファイル名（上の例ならgo.out、Unix上では./go.out）を入力して、プログラムを実行させる。実行後いくつかの出力ファイル（output_*.txt）が作成される。これを見て、パラメーターやコードを変えて再度実行したり、あるいは解析データとして利用する、といった具合。これら出力データの解析には、添付した解析プログラムが便利である。解析プログラムの使用法に関しては後述。

(6) 上記の手順にてプログラムが実行されるのを確認したら、気象データ'climate.txt'をシミュレートさせたい場所のデータと差し替えること。気象データはデータはSEIB-DGVMウェブサイトにて生成可能。


■■■■　実行手順（前回の続きからスタートする場合）　■■■■
(1) リスタートデータの用意
parameter.txt内のFlag_spinup_writeを、「.true.」と設定したうえで、上で示した方法に従ってシミュレーションを実行する。実行後、リスタート用データである、spinup_out.txtが出力される。
(2)リスタート
得られたspinup_out.txtを、spinup_in.txtとファイル名を変える。このファイルは、実行ファイルと同じフォルダにおく必要がある。parameter.txt中のFlag_spinup_readを、「.true.」と設定したうえで、上で示した方法に従ってシミュレーションを実行する。リスタート後は、parameter.txt中のSimulation_yearで指定される年数が、新たにシミュレートされる。


■■■■　設定ファイル　■■■■
設定ファイル(parameter.txt)は、コード実行時に読み込まれ、そのシミュレーションを制御する。設定ファイルの記述は、幾つかのパートに分かれているが、ここではcontrol部に記述されたパラメーターを説明する。control部以外で定義されるパラメーターについては、Module.f90中の記述等を参照すること。なお、Flag_で始まる変数は論理型パラメーターなので、「.true.」又は「.false.」のいずれかが入力される。

Simulation_year       シミュレーションさせる年数
Flag_spinup_read  リスタートするか否かのスイッチ
Flag_spinup_write リスタートファイルを作成するか否かのスイッチ
Flag_output_write 出力ファイルを作成するか否かのスイッチ
Max_loc           仮想林分の一片の長さ(m)
Depth             土壌層一枚の厚さ(mm)。土壌は全部で30層存在する
STEP              樹高の成長計算や、樹冠をDISKに分解する際の最小単位。通常は0.1と指定のこと(0.1m)。
C_in_drymass      バイオマスの単位乾燥重量当たりに炭素が占める割合。
File_no           出力ファイルの装置番号。同じ番号を複数回指定しないこと。また、多くのFortranコンパイラでは、5番が標準入力（キーボード）、6番が標準出力（画面）に結合されているので、5と6は指定しないこと。
Fn_climate        気象データの所在（フルパス）
Fn_location       全球の土地情報と土壌データをフルパスで指定。計7つのファイルをフルパスで指定する：陸面海洋マスク・標高・土壌アルベド・圃場容水量・最大保水量・基質吸引力・萎れ点。各データファイルの形式は、上述。
Fn_spnin          リスタート入力データをフルパスで指定
Fn_spnout         リスタート出力データをフルパスで指定


■■■■　SEIB-Viewer　■■■■
SEIB-Viewerは、SIEB-DGVMの出力を可視化するためのWindows用アプリケーションです。インストールは必要ありませんし、レジストリも使いませんので、フォルダ"SEIB-Viewer"を任意の場所に置いて、その中のSEIB-Viewer.exeを実行するだけで利用できます。このアプリケーションに関する、これ以上の説明は、アプリケーションから参照できるヘルプファイルに記述されています。

なお、SEIB-ViewerはVisual Basic 2005 にて作成されておりますので、その実行にはパソコンに「.NET Framework 2.0」がインストールされている必要があります。このインストールはWindows Updateを利用しても可能ですが、次のサイト（http://msdn.microsoft.com/netframework/downloads/updates/default.aspx）から.NET Framework Version 2.0 Redistributable Packageを入手するのが一番簡単かと思います。なお、32ビット版:x86、64ビット版:x64、64ビット版:IA64、の３種類のパッケージがありますので、お使いの環境に合わせたパッケージを入手してください（よく分からない場合には、Windows Updateを利用されるのが安心です）。
※Vista、またはそれ以上のバージョンのWindowsの場合には、このインストールは必要ありません。


■■■■　main.f90中のコードの流れ　■■■■
main.f90はシミュレーターの基本骨格であり、main.f90の一番外側のループが１シミュレーション日に対応している。この１日のプロセスにおいて各種素過程のサブルーチンが順次呼び出されるが、コードの可読性を高めるために、SEIB-DGVMでは、main.f90より呼び出されたサブルーチンから、他のサブルーチンを呼び出すことは極力避けている。
なお現在のコードでは、指定された気象データが繰り返し入力される仕様となっている。例えば15年分の気象データを指定した場合、15年ごとに気象データが巻き戻されてモデルに入力される。

●初期値の設定（プログラム開始後一回だけ呼び出される）
・Call init_value
各種変数に初期値を与える

・Call spinup_in
必要であればリスタートファイルを読み込む

●DAILY UPDATE OF FIELD PROPERTIES
各種変量のリセット、配列変数への読み込み、移動平均の算出

●物理環境モジュール群（DAILY）
・Call climate_stat
気象環境に関する諸情報を配列変数に取り込み、またそれらを用いて移動平均を算出する。

・Call air
気圧や飽差など、大気条件に関わる変量を算出

・Call radiation
日長やPARなど、光条件に関わる変量を算出

・Call diffused_radiation
仮想林分の鉛直方向における、拡散光の相対強度分布（仮想林分の上空が基準）を算出する。

・Call direct_radiation
各個体の各樹冠レイヤーにおける直接光の相対強度（仮想林分の上空が基準）を算出する。本プログラムにおいて、ここが一番計算時間を消費するため、数日に一回のみ実行されるようにしてある。計算力に余力があるのならば、毎日実行した方が良いだろう。

・Call floor_radiation
相対照度（森林の上端と比較した）を、木本の定着Cellごとに算出する。

・Call ir_index
木本層全体が、また草本層全体が、太陽光を何％が減衰するのかを示す係数（ir_tree、ir_grass）を算出する。また、草本層の最上部における光合成有効放射量（par_grass）も、ここで算出される

・Call fire_regime
森林火災モジュール。アフリカ大陸の場合にはfire_regime2がCallされる。

●生物過程（DAILY）
・Call photosynthesis_condition
光合成速度の算出に必要な諸変数（光飽和時の光合成速度など）を算出する

・Call photosynthesis
1日の光合成量を算出する（草本・木本とも）

・Call lai_optimum
草本レイヤーにおける、最適葉面積指数の算出

・Call maintenance_resp
維持呼吸（草本・木本とも）

・Call turnover
ターンオーバー（草本・木本とも）

・Call leaf_season
葉のフェノロジーの切り替えと、その切り替えの前後における、各種反応（草本・木本とも）

・Call growth_wood
木本の成長のうち、1日ベースでシミュレートする部分（展葉、細根の成長、繁殖）

・Call growth_grass
草本層の成長・繁殖

・Call spacial_limitation
各木本個体の周囲の空間的余裕を算出するプログラム。以下のサブルーチンgrowth_truncにおいて、樹高の成長や樹幹幅を拡大させる前に、呼び出す。

・Call growth_trunc
幹の肥大成長と、それに伴った樹高と樹幹幅の成長

・Call decomposition
土壌有機物の分解モジュール

●生物過程（ANNUALY）
・Call mortality
個々の木本について、死亡を判断する

・Call pft_present
現在、この仮想林分に存在するPFTをリストアップする

・Call crown_adjust
個々の木本について、稼ぎの悪い葉群レイヤーを枯れ上げさせる

・Call crown_shake
個々の木本について、その樹冠の水平方向の位置を、より空間の空いている方向に移動させる

・Call ground_vacant
周囲の空間的余裕などを元に、定着可能なグランドメッシュをリストアップする。下記のサブルーチンestablishで、稚樹の定着を行わせる前に呼び出される

・Call establish
稚樹の定着

・Call crown_coverage
木本の樹冠による地表面のカバー率を算出

・Call grass_priority
翌年に優占型とする草本PFTを、前年度の単位面積当たりNPPを比較することで決める

・Call biome_determine
LAIや優占PFTといった情報を元に、現在の生態系タイプを決定する

●DAILY UPDATE NET-RADIATION & SOIL-WATER STATUS
・Call net_radiation
放射収支やアルベドの計算

・Call waterbudget
水収支の計算

●Daily increment of litter and fuel pools
基本的に、リタープールとFuelプールの増加は、メイン以下の各サブルーチンで算出されたdaily litter fluxesを元に、このパートで集計される。このモデルはリタープールとFuelプールを沢山持ち、その構造も少々ややこしいため、まとめて集計してコードの混乱を避けることが、この集計方法の目的。

●MAKE OUTPUT FILES
・Call output_*
シミュレーション結果の出力


■■■■　解析プログラム　■■■■
●森林動態の基本情報 (analysis.f90)
analysis.f90は、出力ファイルの一つであるoutput_forest.txtを用いて、森林動態に関する基本情報を算出する。算出される情報は、サイズクラス毎の木本密度、サイズクラス毎の幹肥大速度、サイズクラス毎の死亡率の３つである。なお、ここでサイズクラスとは、幹の直径を元とした木本サイズの指標である。
プログラム中のMax_loc、Max_no、Simulation_yearにはシミュレーションの設定ファイルと同じ値を入力する。Interval1には、死亡率と成長速度の算出に際して森林を比較する間隔を'年'で入力する。最低値は1であるが、小さな面積でのシミュレーションの場合、この間隔が余りに短いと誤差が大きくなる。Interval2には、解析の繰り返し間隔である（年）。例えば、これを50と設定し、1000年分のシミュレーションデータについて実行した場合、シミュレーション開始後50, 100, 150, ...., 1000年の計20回について解析を行い、その平均値を出力する。Sizeclass_numではサイズクラスの個数を定義し、Size_setでは、サイズクラスの「切り方」を定義する。例えば、直径が10-15, 15-20, 20-25, 25以上の4クラスを設定する場合にはSizeclass_numは「4」、Size_setは「10,15,20,25」と定義する。


●仮想森林の可視化（Viewer_snapshot.pov, Viewer_animation.pov）
出力ファイルの一つであるoutput_forest.txtを用いて仮想林分の三次元構造を描画することができる。まずpov-ray（http://www.povray.org/）という無料のレンダリングソフトをインストールする。次にoutput_forest.txtと同じディレクトリに添付のViewer_snapshot.povをおき、実行させる。そして#declare year文で表示させたい年（シミュレーション開始後の年数）を入力し、左上のプルダウンメニューで出力画像の大きさ等を指定し、「Run」と書かれたボタンを押せば仮想林分が可視化される。この画像は、同じディレクトリにビットマップ形式で自動保存されている。

Viewer_animation.povは動画作成用のコードで、１年ごとの連続した森林相観を出力する。例えば100年間の森林変動を描かせるのであれば、プログラム14行目を「#declare Flame = 100;」と書き、実行オプションの入力欄（画面右上の空欄）に「+kff100」と入力し、「Run」ボタンを押す。すると連続したビットマップファイルが次々と出力されるので、これをAviMaker（http://www.vector.co.jp/soft/win95/art/se121264.html）などを用いて動画へ変換する。

pov-rayに関して日本語で書かれた情報は、以下のサイトなどにある。
http://www.geocities.co.jp/SiliconValley/5518/
http://nishimulabo.edhs.ynu.ac.jp/~povray/3.5jp/index.htm
http://www.arch.oita-u.ac.jp/a-kse/povjp/index.htm


■■■■　エディタについて　■■■■
Windows上でのコードの表示や編集には「秀丸エディタ」というテキストエディタが便利です。設定メニューから折り返し文字数を100以上に設定し、Fortran用強調定義を読み込ませると、綺麗かつ分かりやすく表示されます。強調定義ファイルを読み込ませる方法は、「その他→ファイルタイプ別の設定→強調表示→読み込み」とメニュー選択した後、この強調表示ファイルを指定します。

「秀丸エディタ」はシェアウェアですので継続して利用する際には送金が必要ですが、学生の方は、学籍にある間のみ送金が免除される「アカデミックフリー制度」が存在します。この制度を利用される際には、以下のサイトの「サポート」ページで必要事項を入力して申し込んでください。

秀丸エディタサイト（コードはこちらから）
http://hide.maruo.co.jp/

強調表示定義はこちらから
http://hide.maruo.co.jp/lib/hilight/index.html


■■■■　改行コードについて　■■■■
readme_j.txt（この文章）、readme_e.txt、そしてPOV-RAYプログラムを除いて、全てのファイルは、改行コードにUNIX標準である「LF形式」を使用しています。Windows上でファイルが適切に表示できない際には、まずは改行コードをWindows標準である「CR+LF形式」に変換してみてください。改行コードの変換には、次のフリーウェアが便利です（http://www.vector.co.jp/soft/win95/util/se296459.html）。同様に、UNIXサーバー上などで、ファイルが正しく表示されない際も、まずは改行コードをお確かめ下さい。


■■■■　その他の注意　■■■■
 ●配布したコードは一地点計算用ですが、start_point.f90を書き換えることにより複数地点の連続シミュレーションが可能になります。但し、それなりに強力な計算環境が必要となります。複数地点計算用のstart_point.f90、またスパコンへジョブを投入する際の各種ファイル(makefileや実行バッチ)が必要な場合はご連絡下さい 
